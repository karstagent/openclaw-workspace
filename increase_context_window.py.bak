#!/usr/bin/env python3
"""
Context Window Extension Tool for OpenAI and Anthropic APIs
Allows requesting extended context windows for compatible models.
"""

import os
import sys
import logging
import json
import argparse
from typing import Dict, Any, Optional, List, Union

# Setup logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger("context-extension")

class ContextWindowExtender:
    """
    Extends context windows for LLM API requests.
    Currently supports:
    - OpenAI API
    - Anthropic API
    - OpenRouter API
    """
    
    def __init__(
        self,
        target_context_length: int = 400000,
        verbose: bool = False,
        api_type: str = "openai"  # "openai", "anthropic", "openrouter"
    ):
        """Initialize the context window extender."""
        self.target_context_length = target_context_length
        self.verbose = verbose
        self.api_type = api_type.lower()
        
        # Set logging level
        if verbose:
            logging.getLogger().setLevel(logging.DEBUG)
        
        # Validate configuration
        if self.target_context_length > 1000000:
            logger.warning(f"Very large context length requested: {target_context_length}. This may not be supported.")
        
        # Initialize clients
        self._openai_client = None
        self._anthropic_client = None
        self._openrouter_client = None
        
        logger.info(f"Initialized context window extender targeting {target_context_length} tokens")
    
    def _load_openai_client(self):
        """Load the OpenAI client."""
        if self._openai_client is None:
            try:
                from openai import OpenAI
                self._openai_client = OpenAI()
                logger.info("Initialized OpenAI client")
            except ImportError:
                logger.error("OpenAI client not found. Please install with: pip install openai")
                raise
        return self._openai_client
    
    def _load_anthropic_client(self):
        """Load the Anthropic client."""
        if self._anthropic_client is None:
            try:
                from anthropic import Anthropic
                self._anthropic_client = Anthropic()
                logger.info("Initialized Anthropic client")
            except ImportError:
                logger.error("Anthropic client not found. Please install with: pip install anthropic")
                raise
        return self._anthropic_client

    def _load_openrouter_client(self):
        """Load a client for OpenRouter."""
        if self._openrouter_client is None:
            try:
                from openai import OpenAI
                # Get API key from environment
                api_key = os.getenv("OPENROUTER_API_KEY")
                if not api_key:
                    logger.warning("OPENROUTER_API_KEY not found in environment.")
                
                # Create client with OpenRouter base URL
                self._openrouter_client = OpenAI(
                    base_url="https://openrouter.ai/api/v1",
                    api_key=api_key
                )
                logger.info("Initialized OpenRouter client")
            except ImportError:
                logger.error("OpenAI client not found. Please install with: pip install openai")
                raise
        return self._openrouter_client
    
    def extend_openai_request(self, **kwargs):
        """Extend context window for OpenAI API requests."""
        client = self._load_openai_client()
        
        # Copy kwargs to avoid modifying the original
        new_kwargs = kwargs.copy()
        
        # Add context window extension parameters
        # Note: OpenAI doesn't have an official parameter for this,
        # but we can try an experimental approach
        new_kwargs["base_context_length"] = self.target_context_length
        
        # Log the request parameters
        if self.verbose:
            logger.debug(f"Modified OpenAI request parameters: {new_kwargs}")
        
        # Make the API call with extended context
        try:
            response = client.chat.completions.create(**new_kwargs)
            return response
        except Exception as e:
            logger.error(f"Error with extended context window: {str(e)}")
            
            # Fall back to standard request without extension
            logger.info("Falling back to standard request")
            fallback_kwargs = kwargs.copy()  # Use original kwargs
            return client.chat.completions.create(**fallback_kwargs)
    
    def extend_anthropic_request(self, **kwargs):
        """Extend context window for Anthropic API requests."""
        client = self._load_anthropic_client()
        
        # Copy kwargs to avoid modifying the original
        new_kwargs = kwargs.copy()
        
        # Add context window extension parameters
        new_kwargs["max_tokens"] = min(
            kwargs.get("max_tokens", 4096),  # Use provided max_tokens or default
            self.target_context_length // 10  # Limit output to 10% of context
        )
        
        # If messages not in kwargs, convert from prompt
        if "messages" not in new_kwargs and "prompt" in new_kwargs:
            new_kwargs["messages"] = [{"role": "user", "content": new_kwargs.pop("prompt")}]
        
        # Log the request parameters
        if self.verbose:
            logger.debug(f"Modified Anthropic request parameters: {new_kwargs}")
        
        # Make the API call with extended context
        try:
            response = client.messages.create(**new_kwargs)
            return response
        except Exception as e:
            logger.error(f"Error with extended context window: {str(e)}")
            
            # Fall back to standard request without extension
            logger.info("Falling back to standard request")
            fallback_kwargs = kwargs.copy()  # Use original kwargs
            return client.messages.create(**fallback_kwargs)

    def extend_openrouter_request(self, **kwargs):
        """Extend context window for OpenRouter API requests."""
        client = self._load_openrouter_client()
        
        # Copy kwargs to avoid modifying the original
        new_kwargs = kwargs.copy()
        
        # Add OpenRouter-specific headers for context extension
        new_kwargs["extra_headers"] = {
            **(new_kwargs.get("extra_headers", {})),
            "HTTP-Referer": "https://openclaw.ai",  # Replace with actual domain
            "X-Title": "OpenClaw Context Extension",
            "X-Context-Length": str(self.target_context_length)
        }
        
        # Log the request parameters
        if self.verbose:
            logger.debug(f"Modified OpenRouter request parameters: {new_kwargs}")
        
        # Make the API call with extended context
        try:
            response = client.chat.completions.create(**new_kwargs)
            return response
        except Exception as e:
            logger.error(f"Error with extended context window: {str(e)}")
            
            # Fall back to standard request without extension
            logger.info("Falling back to standard request")
            fallback_kwargs = kwargs.copy()  # Use original kwargs
            
            # Remove our custom headers
            if "extra_headers" in fallback_kwargs:
                for header in ["X-Context-Length"]:
                    if header in fallback_kwargs["extra_headers"]:
                        del fallback_kwargs["extra_headers"][header]
            
            return client.chat.completions.create(**fallback_kwargs)
    
    def extend_request(self, **kwargs):
        """
        Extend context window for API requests based on configured API type.
        """
        if self.api_type == "openai":
            return self.extend_openai_request(**kwargs)
        elif self.api_type == "anthropic":
            return self.extend_anthropic_request(**kwargs)
        elif self.api_type == "openrouter":
            return self.extend_openrouter_request(**kwargs)
        else:
            raise ValueError(f"Unsupported API type: {self.api_type}")

def main():
    """Command-line interface for testing."""
    parser = argparse.ArgumentParser(description="Test the context window extension")
    parser.add_argument("--input", "-i", required=True, help="Input file containing messages or prompt")
    parser.add_argument("--output", "-o", help="Output file for response")
    parser.add_argument("--context-length", "-c", type=int, default=400000, help="Target context length (default: 400000)")
    parser.add_argument("--api", "-a", choices=["openai", "anthropic", "openrouter"], default="openai", help="API type")
    parser.add_argument("--model", "-m", default=None, help="Model to use")
    parser.add_argument("--verbose", "-v", action="store_true", help="Verbose output")
    
    args = parser.parse_args()
    
    # Initialize extender
    extender = ContextWindowExtender(
        target_context_length=args.context_length,
        verbose=args.verbose,
        api_type=args.api
    )
    
    # Read input
    with open(args.input, 'r', encoding='utf-8') as f:
        content = f.read()
    
    # Prepare request parameters
    if args.api == "openai" or args.api == "openrouter":
        request_params = {
            "model": args.model or "gpt-4",
            "messages": [{"role": "user", "content": content}],
            "max_tokens": 4000
        }
    else:  # anthropic
        request_params = {
            "model": args.model or "claude-3-opus-20240229",
            "messages": [{"role": "user", "content": content}],
            "max_tokens": 4000
        }
    
    # Make the request
    response = extender.extend_request(**request_params)
    
    # Output result
    if args.output:
        with open(args.output, 'w', encoding='utf-8') as f:
            if args.api == "openai" or args.api == "openrouter":
                f.write(response.choices[0].message.content)
            else:  # anthropic
                f.write(response.content[0].text)
        print(f"Response written to {args.output}")
    else:
        if args.api == "openai" or args.api == "openrouter":
            print(response.choices[0].message.content)
        else:  # anthropic
            print(response.content[0].text)

if __name__ == "__main__":
    main()